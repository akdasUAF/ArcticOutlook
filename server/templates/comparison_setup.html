{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dynamic.css') }}">    
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" 
integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" 
integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
<title>Compare Files Part 1</title>
{% endblock %}
{% block body %}
<nav class="navbar navbar-expand-lg navbar-light mb-3" style="background-color: #e3f2fd;">
    <div class="container-fluid">
        <a class="navbar-brand disabled" href="#">Uploading a file to MongoDB.</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item px-1">
                    <a id="step_1" class="nav-link border border" href="{{ url_for('reset_upload') }}">Reset</a>
                </li>
                <li class="nav-item px-1">
                    <a id="step_1" class="nav-link border" href="{{ url_for('upload_csv') }}">Step 1: Upload CSV</a>
                </li>
                <li class="nav-item px-1">
                    <a id="step_2" class="nav-link border" href="{{ url_for('display_csv') }}">Step 2: View Table</a>
                </li>
                <li class="nav-item px-1">
                    <a id="step_3" class="nav-link border border-primary active" href="#">Step 3: Column Matching</a>
                </li>
                <li class="nav-item px-1">
                    <a id="step_4" class="nav-link border disabled" href="{{ url_for('compare_csv') }}">Step 4: Table Comparison</a>
                </li>
                <li class="nav-item px-1">
                    <a id="step_5" class="nav-link border disabled" href="{{ url_for('query_manager') }}">Query Manager</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    {% for category, message in messages %}
        {% if category == 'success' %}
            <div class="alert alert-success alert-dismissible fade show " role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% elif category == 'error' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    {% endfor %}
{% endif %}
{% endwith %}
<div id="main" class="row g-2">
    <p>This page allows the user to specify which columns should be compared between the newly uploaded file and the current data.
        Additionally, it allows the declaration of an index column for each table. The index specified must be <b>unique</b> or the comparison
        will not work.   
        If no index is specified, it will use the default index (row number) as an index.
        As of right now, if multiple columns try to compare to one column, it will not properly style. Subsequent columns will register as 'new' columns.</p>
    <p>
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#index_info" aria-expanded="false" aria-controls="index_info">Set Index</button>
    </p>
    <div class="row">
        <div class="col">
            <div class="collapse multi-collapse col-6" id="index_info">
                <div class="card card-body">
                    <form id="set_index" method="POST">
                        <p>Select an index column. This is based on the <b>Uploaded File's</b> column names. 
                            The column matched to it will be considered the index of the <b>Original File</b> 
                            for the data comparison.</p>
                        <p>Current Index: {{indexes}}</p>
                        <label class="form-label" for="index">Index</label>
                        <select class="form-select bg-light bg-gradient mb-3" name="index">
                            {% for c in uploaded_columns %}
                            <option value="{{c}}" {% if c == indexes[0] %} selected {% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                        <input type="submit" class="btn btn-outline-primary" name="set_index" value="Set Index">
                    </form>
                </div>
            </div>
        </div>
    </div>
    <form id="column_comparison" method="POST">
        <div class="row g-0 align-items-center mb-3">
            <div class="col bg-primary bg-gradient text-white rounded-bottom">
                <label class="form-label text-center" class="input-group-text" for="uploaded_columns">Uploaded File Columns</label>
                <ul class="list-group" name="uploaded_columns" style="overflow-y:auto; max-height:20em;">
                    {% for c in uploaded_columns %}
                    {% set compare_col = 'no' %}
                    <li class = "list-group-item">
                        <label class="form-label" for="{{c}}">{{c}}</label>
                        <!--Need to add an onload script to change color on page load-->
                        <select class="form-select bg-gradient" name="{{c}}" id="{{c}}" onchange="changeColor(this, '{{c}}');">
                            <option value="no_compare">No Comparison</option>
                            {% for x in original_columns %}
                                {% if form_dict["columns"][c] == x %}
                                    {% set compare_col = 'yes' %}
                                    <option value="{{x}}" selected="selected">{{ x }}</option>
                                {% elif c == x and compare_col == 'no' %}
                                    <option value="{{x}}" selected="selected">{{ x }}</option>
                                {% else %}
                                    <option value="{{x}}">{{ x }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <input type="submit" class="btn btn-primary" name="continue" value="Continue to Next Step">
    </form>
</div>
<script>
    function changeColor(colorParam, id) {
        var optionElement = document.getElementById(id);
        if (colorParam.value === "no_compare")
        {
            optionElement.style.backgroundColor = "LightCoral";
        }
        else
        {
            optionElement.style.backgroundColor = "transparent";
        }
};
</script>
  {% endblock %}