{% extends 'base.html' %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dynamic.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
    <title>Dynamic Scraper</title>
{% endblock %}

{% block body %}
<nav class="nav">
    <a id="return" class="nav-link" href="{{ url_for('index') }}">Return to Main Page</a>
    <a id="reset" class="nav-link" href="{{ url_for('reset_scraper') }}">Reset Scraper</a>
    <a id="return" class="nav-link" href="{{ url_for('scraper_ui') }}">Return to Scraper Instruction List</a>
</nav>
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    {% for category, message in messages %}
        {% if category == 'success' %}
            <div class="alert alert-success alert-dismissible fade show " role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% elif category == 'error' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    {% endfor %}
{% endif %}
{% endwith %}
<div id="main">  
    <div id="output">
        <h2>Output</h2>
        <form id="output-form" method="POST">
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label" for="upload_confirm">Upload to MongoDB?</label>
                    <select class="form-select" id="upload_confirm" onchange="showMore(this)">
                        <option selected disabled value="">Select Option</option>
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
            </div>
            <div id="upload_yes" style="display:none" class="row mb-4">
                <div class="col md-9 input-group">
                    <span class="input-group-text" for="Connection">Connection String</span>
                    <input name="Connection" class="form-control" type="text" value={{default[0]}} aria-describedby=" con_tip">
                </div>
                <div class="form-text mb-3" id="con_tip">Example: mongodb+srv://<username>:<password>@beyondthebasics.abcde.mongodb.net/test</div>
                
                <div class="col md-9">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="alt-db">
                        <label class="form-check-label" for="alt-db">Select Database from MongoDB Settings</label>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text" for="Database">Database Name</span>
                        <input name="Database" id="database-text" class="form-control" type="text" aria-describedby=" db_tip" value={{default[1]}}>
                        <select class="form-control hidden-db" id="database-list" name="Database" disabled size="5" style="display: none;" aria-describedby=" db_tip">
                            {% for db in names %}
                            <option value="{{db}}" id="{{db}}">{{db}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-text mb-3" id="db_tip">Example: Outlook</div>
                </div>

                <div class="col md-9">           
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="alt-col">
                        <label class="form-check-label" for="alt-col">Select Collection from MongoDB Settings</label>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text" for="Collection">Collection Name</span>
                        <input name="Collection" id="collection-text" class="form-control" type="text" aria-describedby=" coll_tip" value={{default[2]}}>
                        <select class="form-control hidden-col" id="collection-list" name="Collection" disabled size="5" style="display: none;" aria-describedby=" coll_tip">
                            {% for db in names %}
                            <optgroup label="{{db}}">
                                {% for col in names[db] %}
                                    <option value="{{db}}: {{col}}" id="">{{col}}</option>
                                {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-text mb-3" id="coll_tip">Example: Data_Dump</div>
                </div>     
            </div>
            <script>
                var showMore = function(option)
                    {
                        if (option.value == 'Yes')
                        {
                            document.getElementById('upload_yes').style.display = '';
                        }
                        else
                        {
                            document.getElementById('upload_yes').style.display = 'none';
                        }
                    }
            </script>
            <input type="submit" class="btn btn-primary" name="upload" value="Upload to MongoDB">
            <input type="submit" class="btn btn-primary" name="download" value="Download as JSON">
            <input type=submit class="btn btn-primary" name="view-as-table" value="View as Table">
            {% if tables %}
            <input type="submit" class="btn btn-primary" name="download-csv" value="Download as CSV">
            <div style="overflow-y: scroll; overflow-x: scroll; max-height: 700px;">
                {% for table in tables %}
                    {{ table|safe }}
                {% endfor %}
            </div>
            {% else %}
            <div class="row mb-4 mt-4 border scraped_values">
                <pre id="json_output" style="overflow: scroll; height:50vh; width:hidden;">{{ output }}</pre>
            </div>
            {% endif %}
        </form>
    </div>
</div>
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.js"></script>
<script>
    $(document).ready(function () {
    $('#pwsid').DataTable();
    });
</script>
<script>
    var checkbox = document.querySelector("#alt-db");
    var select = document.querySelector("#database-list");
    var altSelect = document.querySelector("#database-text");

    checkbox.addEventListener('change', function(event) {
        select.classList.toggle('hidden-db');
        select.disabled = !select.disabled;

        altSelect.classList.toggle('hidden-db');
        altSelect.disabled = !altSelect.disabled;

        if (select.classList.contains('hidden-db')) {
            altSelect.style.display = "inline";
            select.style.display = "none";
        }
        else
        {
            select.style.display = "inline";
            altSelect.style.display = "none";
        }
    });
</script>
<script>
    var checkboxCol = document.querySelector("#alt-col");
    var selectCol = document.querySelector("#collection-list");
    var altSelectCol = document.querySelector("#collection-text");

    checkboxCol.addEventListener('change', function(event) {

        selectCol.classList.toggle('hidden-col');
        selectCol.disabled = !selectCol.disabled;
        
        altSelectCol.classList.toggle('hidden-col');
        altSelectCol.disabled = !altSelectCol.disabled;

        if (selectCol.classList.contains('hidden-col')) {
            altSelectCol.style.display = "inline";
            selectCol.style.display = "none";
        }
        else
        {
            selectCol.style.display = "inline";
            altSelectCol.style.display = "none";
        }
    });
</script>
{% endblock %}